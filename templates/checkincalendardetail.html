{% extends "base.html" %}

{% block title %}签到日历 - 健康监测系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题和按钮组 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-alt me-2"></i>签到日历
        </h1>
        <div class="d-flex">
            <a href="{{ url_for('checkin_detail') }}" class="btn btn-primary">
                <i class="fas fa-list me-2"></i>列表视图
            </a>
        </div>
    </div>

    <!-- 月份导航和统计卡片 -->
    <div class="row mb-4">
        <!-- 月份导航卡片 -->
        <div class="col-md-3">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-primary">
                    <h6 class="m-0 font-weight-bold text-white">月份导航</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('checkin_calendar_month', year=prev_month.year, month=prev_month.month) }}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        <h5 class="mb-0 text-primary">{{ current_month.strftime('%Y年%m月') }}</h5>
                        <a href="{{ url_for('checkin_calendar_month', year=next_month.year, month=next_month.month) }}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月收入卡片 -->
        <div class="col-md-3">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-success">
                    <h6 class="m-0 font-weight-bold text-white">本月收入</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h4 class="mb-0 text-success">¥{{ monthly_income }}</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- 时间段选择卡片 -->
        <div class="col-md-3">
            <div class="card shadow h-100">
                <div class="card-header py-3 bg-info">
                    <h6 class="m-0 font-weight-bold text-white">自定义时间段</h6>
                </div>
                <div class="card-body">
                    <div id="dateRangeForm" class="mb-0">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small text-muted">开始日期</label>
                                <input type="date" class="form-control form-control-sm" id="startDate" name="start_date">
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">结束日期</label>
                                <input type="date" class="form-control form-control-sm" id="endDate" name="end_date">
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-info btn-sm" id="calculateBtn">
                                <i class="fas fa-calculator me-1"></i>计算收入
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 阶段收入卡片 -->
        <div class="col-md-3">
            <div class="card shadow h-100" id="resultCard">
                <div class="card-header py-3 bg-warning">
                    <h6 class="m-0 font-weight-bold text-white">阶段收入</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <span id="dateRange" class="d-block text-muted small mb-2">选择日期范围</span>
                        <h4 class="mb-0 text-warning" id="totalAmount">¥0</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日历表格 -->
    <div class="card shadow">
        <div class="card-header py-3 bg-gradient-primary">
            <h6 class="m-0 font-weight-bold text-white">签到日历</h6>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <thead class="bg-light">
                    <tr class="text-center">
                        <th class="text-primary">周一</th>
                        <th class="text-primary">周二</th>
                        <th class="text-primary">周三</th>
                        <th class="text-primary">周四</th>
                        <th class="text-primary">周五</th>
                        <th class="text-primary">周六</th>
                        <th class="text-danger">周日</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in calendar %}
                    <tr>
                        {% for day in week %}
                        {% if day != 0 %}
                        {% set date = '%d-%02d-%02d'|format(current_month.year, current_month.month, day) %}
                        {% set record = records.get(date, {}) %}
                        <td class="text-center align-middle position-relative {% if record.get('completed') %}bg-success text-white{% elif record.get('checkin') or record.get('checkout') %}bg-warning{% endif %}" 
                            style="height: 100px;">
                            <div class="d-flex flex-column h-100">
                                <div class="mb-2 {% if loop.last %}text-danger{% endif %}">{{ day }}</div>
                                {% if record %}
                                <div class="small">
                                    {% if record.get('completed') %}
                                    <div><i class="fas fa-check-circle me-1"></i>已签到</div>
                                    <div><i class="fas fa-check-circle me-1"></i>已签退</div>
                                    <div class="mt-2">
                                        <span class="badge bg-light text-success">¥75</span>
                                    </div>
                                    {% else %}
                                    {% if record.get('checkin') %}
                                    <div><i class="fas fa-check-circle me-1"></i>已签到</div>
                                    {% endif %}
                                    {% if record.get('checkout') %}
                                    <div><i class="fas fa-check-circle me-1"></i>已签退</div>
                                    {% endif %}
                                    {% if record.get('income') %}
                                    <div class="mt-2">
                                        <span class="badge bg-light text-warning">¥{{ record.get('income') }}</span>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        {% else %}
                        <td class="bg-light"></td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
    document.getElementById('endDate').value = lastDayOfMonth.toISOString().split('T')[0];

    // 使用 jQuery 绑定点击事件
    $('#calculateBtn').on('click', function() {
        calculateTotal();
    });
});

function calculateTotal() {
    console.log('calculateTotal function called'); // 调试日志
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('请选择开始和结束日期');
        return;
    }
    
    // 显示加载状态
    document.getElementById('dateRange').textContent = '计算中...';
    document.getElementById('totalAmount').textContent = '...';
    
    console.log('Fetching data for dates:', startDate, endDate); // 调试日志
    
    // 使用 jQuery 的 AJAX
    $.ajax({
        url: '/calculate_income_range',
        method: 'GET',
        data: {
            start_date: startDate,
            end_date: endDate
        },
        success: function(data) {
            console.log('收到数据:', data);  // 调试日志
            document.getElementById('dateRange').textContent = 
                `${startDate} 至 ${endDate}`;
            document.getElementById('totalAmount').textContent = 
                `¥${data.total || 0}`;
        },
        error: function(xhr, status, error) {
            console.error('计算收入时出错:', error);
            alert('计算收入时出错: ' + error);
            document.getElementById('dateRange').textContent = '选择日期范围';
            document.getElementById('totalAmount').textContent = '¥0';
        }
    });
}
</script>
{% endblock %} 